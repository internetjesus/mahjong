"use strict";var mahjong;mahjong=angular.module("mahjong",["ui.router","ui.bootstrap","LocalStorageModule","angular-loading-bar","ngToast","mahjong.games","mahjong.auth"]),mahjong.constant("config",{apiUrl:"http://mahjongmayhem.herokuapp.com"}),mahjong.run(["$rootScope","$state","$stateParams","authFactory",function(a,b,c,d){a.$state=b,a.$stateParams=c,d.initialize(),a.auth=d}]),mahjong.config(["ngToastProvider",function(a){a.configure({animation:"slide",timeout:3e3,dismissButton:!0,dismissButtonHtml:"&times;",dismissOnClick:!0,horizontalPosition:"center",maxNumber:3})}]),mahjong.config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]),mahjong.config(["localStorageServiceProvider",function(a){a.setPrefix("mahjong")}]),mahjong.config(["$httpProvider",function(a){a.interceptors.push("HttpRequestInterceptor")}]),function(){function a(a,b){b.otherwise("/games"),a.state("mahjong",{url:"","abstract":!0,templateUrl:"app/shared/base/baseMaster.html",controller:"BaseController"}).state("callback",{url:"/callback?username&token",template:"",controller:["$scope","$state","$stateParams","authFactory",function(a,b,c,d){d.store(c.username,c.token),b.go("mahjong.games")}]}).state("mahjong.games",{url:"/games",templateUrl:"app/components/games/gameList.html",controller:"GameListController as vm",resolve:{templates:["templateService",function(a){return a.getAll()}]}}).state("mahjong.view",{url:"/games/:gameId","abstract":!0,templateUrl:"app/components/games/gameView.html",controller:"GameViewController as vm",resolve:{game:["gameService","$stateParams","ngToast","$state",function(a,b,c,d){return a.getById(b.gameId)}]}}).state("mahjong.view.board",{url:"/board",templateUrl:"app/components/games/gameBoard.html",controller:"GameBoardController as vm",resolve:{tiles:["gameService","$state","game",function(a,b,c){return"open"!=c.data.state?a.getGameTiles(c.data._id,!1):null}]}}).state("mahjong.view.players",{url:"/players",templateUrl:"app/components/players/playerList.html",controller:"PlayerListController as vm",resolve:{players:["gameService","$stateParams","ngToast","$state",function(a,b,c,d){return a.getGamePlayers(b.gameId)}]}}).state("mahjong.view.matches",{url:"/matches",templateUrl:"app/components/games/gameMatches.html",controller:"GameMatchesController",resolve:{matchedTiles:["gameService","$stateParams",function(a,b){return a.getGameTiles(b.gameId,!0)}]}}).state("mahjong.create",{url:"/new",templateUrl:"app/components/games/gameCreate.html",controller:"GameCreateController as vm",resolve:{templates:["templateService",function(a){return a.getAll()}]}})}angular.module("mahjong").config(a),a.$inject=["$stateProvider","$urlRouterProvider"]}(),function(){angular.module("mahjong.games",[])}(),function(){function a(a,b,c,d,e,f,g){function h(){null==a&&(e.create({className:"warning",content:r.data.message}),g.go("mahjong.games")),n.game=a.data,n.tiles=c?c.data:null,n.canPlay=i(),n.canPlay||"playing"!=n.game.state||e.create({className:"info",content:"You are spectating this game! You have no power here..."})}function i(){if("playing"==n.game.state){var a=_.find(n.game.players,function(a){return a._id==f.getUsername()});return null!=a}return!1}function j(a){return n.canPlay?void(m(a)?e.create({className:"info",content:"Make sure the tile is clear on the top and left or right!"}):(n.tileSet.push(a),a.clicked=!0,2==n.tileSet.length&&(l()?d.match(n.game._id,n.tileSet[0]._id,n.tileSet[1]._id).then(function(a){k()},function(a){k(),e.create({className:"info",content:a.data.message})}):(k(),e.create({className:"info",content:"That's not a match..."}))))):!1}function k(){null!=n.tileSet[0]&&(n.tileSet[0].clicked=!1),null!=n.tileSet[1]&&(n.tileSet[1].clicked=!1),n.tileSet=[]}function l(){if(2==n.tileSet.length){var a=n.tileSet[0],b=n.tileSet[1];if(a._id==b._id)return!1;if(a.tile.matchesWholeSuit||b.tile.matchesWholeSuit)return a.tile.suit===b.tile.suit;if(a.tile.suit===b.tile.suit)return a.tile.name===b.tile.name}return!1}function m(a){var b=!1,c=!1,d=!1;return _.each(n.tiles,function(e){return a==e?!0:void(e.xPos+2==a.xPos&&a.zPos<=e.zPos&&(e.yPos==a.yPos||a.yPos==e.yPos+1)?b=!0:e.xPos-2==a.xPos&&a.zPos<=e.zPos&&(e.yPos==a.yPos||a.yPos==e.yPos+1)?c=!0:!(e.zPos>a.zPos)||e.xPos+1!=a.xPos&&e.xPos!=a.xPos&&e.xPos-1!=a.xPos||e.yPos+1!=a.yPos&&e.yPos!=a.yPos&&e.yPos-1!=a.yPos||(d=!0))}),d||c&&b}var n=this;n.game={},n.tiles={},n.tileSet=[],n.tileClick=j,n.canPlay=!1,h(),b.on("start",function(a){n.game.state="playing",d.getGameTiles(n.game._id,!1).then(function(a){n.tiles=a.data})}),b.on("match",function(a){for(var b=0;b<n.tiles.length;b++)n.tiles[b]._id==a[0]._id?n.tiles.splice(b,1):n.tiles[b]._id==a[0].match.otherTileId&&n.tiles.splice(b,1)}),b.on("end",function(a){n.game.state="finished",n.canPlay=!1,e.create({className:"info",content:"This game has ended!"})})}angular.module("mahjong.games").controller("GameBoardController",a),a.$inject=["game","socket","tiles","gameService","ngToast","authFactory","$state"]}(),function(){function a(a,b,c,d){function e(){g.templates=d.data}function f(d){d&&b.createNew(g.game.templateName,g.game.minPlayers,g.game.maxPlayers).then(function(b){c.create({className:"success",content:"Game created! Have fun"}),a.go("mahjong.view.board",{gameId:b.data._id})},function(a){c.create({className:"warning",content:a.data.message})})}var g=this;g.game={},g.templates={},g.createGame=f,e()}angular.module("mahjong.games").controller("GameCreateController",a),a.$inject=["$state","gameService","ngToast","templates"]}(),function(){function a(a,b,c,d){function e(){j.templates=a.data,g()}function f(){j.loadGames()}function g(){b.getAll(12,j.currentPage,j.gamesFilter.gameTemplate,j.gamesFilter.state,j.gamesFilter.createdBy).success(function(a,b,c){j.bigTotalItems=parseInt(c("X-total-count")),j.games=a})}function h(a){b.join(a).then(function(b){c.create("Game joined. Redirect..."),d.go("mahjong.view.players",{gameId:a})},function(a){c.create({className:"warning",content:a.data.message})})}function i(a){return b.canJoinGame(a)}var j=this;j.sortType="createdOn",j.sortReverse=!0,j.bigTotalItems=0,j.currentPage=1,j.maxSize=5,j.gamesFilter={createdBy:"",state:"",gameTemplate:""},j.games=null,j.templates={},j.pageChanged=f,j.joinGame=h,j.canJoinGame=i,j.loadGames=g,e()}angular.module("mahjong.games").controller("GameListController",a),a.$inject=["templates","gameService","ngToast","$state"]}(),function(){function a(a,b,c){function d(c,d,e,f,g){var h={pageSize:c,pageIndex:d,gameTemplate:e,state:f,createdBy:g};return b({method:"GET",url:a.apiUrl+"/Games",params:h})}function e(c){return b({method:"GET",url:a.apiUrl+"/Games/"+c})}function f(c,d,e){var f={templateName:c,minPlayers:d,maxPlayers:e};return b({method:"POST",url:a.apiUrl+"/Games",data:f})}function g(c){return b({method:"GET",url:a.apiUrl+"/Games/"+c+"/Players"})}function h(c,d){var d=d?"true":"false";return b({method:"GET",url:a.apiUrl+"/Games/"+c+"/Tiles?matched="+d})}function i(c){return b({method:"POST",url:a.apiUrl+"/Games/"+c+"/Start",data:{}})}function j(a){var b=!0;if("open"!=a.state||a.players.length==a.maxPlayers)b=!1;else for(var d=0,e=a.players.length;e>d;d++)if(a.players[d]._id==c.getUsername()){b=!1;break}return b}function k(c,d,e){var f={tile1Id:d,tile2Id:e};return b({method:"POST",url:a.apiUrl+"/Games/"+c+"/Tiles/matches",data:f})}function l(c){return b({method:"POST",url:a.apiUrl+"/Games/"+c+"/Players"})}var m={getAll:d,getById:e,createNew:f,getGamePlayers:g,getGameTiles:h,start:i,canJoinGame:j,match:k,join:l};return m}angular.module("mahjong.games").factory("gameService",a),a.$inject=["config","$http","authFactory"]}(),function(){function a(a,b,c,d,e){function f(){j.game=a.data;var b=e.apiUrl+"?gameId="+j.game._id;d.initialize(io(b))}function g(){b.start(j.game._id).then(function(a){c.create({className:"success",content:a.data})},function(a){c.create({className:"warning",content:a.data.message})})}function h(){return b.canJoinGame(j.game)}function i(){b.join(j.game._id).then(function(a){c.create("Game joined!")},function(a){c.create({className:"warning",content:a.data.message})})}var j=this;j.game={},j.startGame=g,j.canJoinGame=h,j.joinGame=i,f(),d.on("start",function(a){j.game.state="playing"}),d.on("end",function(a){j.game.state="finished"})}angular.module("mahjong.games").controller("GameViewController",a),a.$inject=["game","gameService","ngToast","socket","config"]}(),function(){function a(a,b){function c(){d.players=a.data}var d=this;d.players={},c(),b.on("playerJoined",function(a){d.players.push(a)})}angular.module("mahjong.games").controller("PlayerListController",a),a.$inject=["players","socket"]}(),function(){function a(a,b){function c(){return b({method:"GET",url:a.apiUrl+"/GameTemplates"})}var d={getAll:c};return d}angular.module("mahjong.games").factory("templateService",a),a.$inject=["config","$http"]}(),function(){function a(){return{name:"tile",restrict:"E",replace:!0,templateUrl:"app/components/tiles/tileTemplate.html",link:function(a,b,c){b.addClass(a.tile.tile.suit),b.addClass(a.tile.tile.suit+"-"+a.tile.tile.name),b.css("z-index",a.tile.yPos+50*(a.tile.zPos+1)-a.tile.xPos),b.css("top",43*a.tile.yPos-10*a.tile.zPos+"px"),b.css("left",33*a.tile.xPos+10*a.tile.zPos+"px"),a.$watch("tile.clicked",function(){a.tile.clicked?b.addClass("clicked"):b.removeClass("clicked")})}}}angular.module("mahjong.games").directive("tile",a)}(),function(){angular.module("mahjong.auth",[])}(),function(){function a(a,b){function c(){i=g()}function d(){return null==b.get("token")}function e(a,c){i=a,b.set("username",i),b.set("token",c)}function f(){return i="",b.remove("username","token"),b.clearAll(),!0}function g(){return b.get("username")}function h(){return b.get("token")}var i="",j={username:i,initialize:c,isGuest:d,store:e,destroy:f,getUsername:g,getToken:h};return j}angular.module("mahjong.auth").factory("authFactory",a),a.$inject=["config","localStorageService"]}(),function(){function a(a){return{request:function(b){return a.isGuest()||(b.headers["x-username"]=a.getUsername(),b.headers["x-token"]=a.getToken()),b}}}angular.module("mahjong.auth").factory("HttpRequestInterceptor",a),a.$inject=["authFactory"]}(),angular.module("mahjong").controller("BaseController",["$scope","config","authFactory",function(a,b,c){a.oAuthUrl=b.apiUrl+"/auth/avans?callbackUrl="+encodeURIComponent("http://localhost:8080/#/callback"),a.signOut=function(){c.destroy()}}]),function(){angular.module("mahjong").factory("socket",["$rootScope",function(a){var b=null;return{initialize:function(a){b=a},on:function(c,d){null!=b&&b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){null!=b&&b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}])}();